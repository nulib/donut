packages:
  yum:
    nfs-utils: []
    jq: []
files:
  "/home/ec2-user/mount_efs_volumes.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      jqexpr='[.Parameters[]] | map(((.Name / "/")|last|ascii_upcase) + "=\"" + (.Value) + "\"") | .[]'
      config=$(aws ssm get-parameters-by-path --path "/${SETTINGS__NAME}/Deploy/" | jq -r $jqexpr)
      eval $config

      # Mount working volume and create working/temp directories
      mkdir -p /var/donut-working
      mountpoint -q /var/donut-working
      if [ $? -ne 0 ]; then
        mount -t nfs4 ${WORKING_VOLUME}:/ /var/donut-working/
      fi
      chown webapp:webapp /var/donut-working
      mkdir -p /var/donut-working/temp
      mkdir -p /var/donut-working/work

      # Mount derivatives volume and create derivatives directory
      mkdir -p /var/donut-derivatives
      mountpoint -q /var/donut-derivatives
      if [ $? -ne 0 ]; then
        mount -t nfs4 ${DERIVATIVE_VOLUME}:/ /var/donut-derivatives/
      fi
      chown webapp:webapp /var/donut-derivatives
commands:
  01_mount:
    command: "/home/ec2-user/mount_efs_volumes.sh"
